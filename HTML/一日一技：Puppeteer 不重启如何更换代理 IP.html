 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>我们知道，在写爬虫的过程中，如果总是使用同一个 IP，很容易就会被网站识别并封禁，所以需要使用代理 IP 并经常更换。</p> <p>但如果你在网上搜索 Puppeteer 如何更换代理 IP，你会发现，网上的解决方案一般是这样写的：</p> <p>这种写法有一个问题，如果你要更换 IP，必须重启爬虫。那么有没有办法不重启爬虫也能更换代理 IP 呢？</p> <p>方法有，并且有两个。</p> <p>对一些网站来说，只要每次访问的 IP 不一样就可以避免被封禁，那么我们可以使用隧道代理。隧道代理供应商会给我们提供一个唯一的域名和端口。我们把它设置为爬虫的代理就可以了。代理供应商会在后端自动给每一次请求更换 IP，不用我们来操心。</p> <p>我们使用<a href="https://www.qg.net/business/proxyip/42.html" rel="noopener" target="_blank">青果云</a>的隧道代理来做演示。它可以免费试用2小时。我获取到的代理 IP 地址为：<code>http://D5A913AF:<a class="__cf_email__" data-cfemail="1a582b5e5f28592e2c5e29282b5a6e6f74747f76346b7d34747f6e" href="/cdn-cgi/l/email-protection">[email protected]</a>:11151</code>。于是，我可以修改上面的 Puppeteer 代码中的 IP 地址：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-12-19-11-05-57.png"/></p> <p>IP 并不是换得越频繁越好。如果网站需要登录，那么你登录以后每一次请求都更换 IP，这反而会弄巧成拙，让网站更加怀疑你是不是爬虫。还有一些网站，例如淘宝，当你访问一个页面的时候，它会自动301跳转多次。在这几次跳转的时候，你必须保持 IP 一致，否则它就会屏蔽你。</p> <p>我们有时候需要实现按需更换代理 IP——让开发者在需要更换 IP 的时候，再来更换。</p> <p>为了让 Puppeteer 实现这个目标，我们可以安装一个第三方模块：<code>puppeteer-page-proxy</code>：</p> <p>安装完成以后，我们来使用看看：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-12-19-11-22-37.png"/></p> <p>当我们需要更换 IP 的时候，只需要在代码里面执行<code>await useProxy(page 'http://账号:密码@IP:端口')</code>，就可以更换新的 IP 了。如果你的代理 IP 没有账号密码，那么可以把代码改成：<code>await useProxy(page 'http://IP:端口')</code>。</p> <p>可能有人会问，你上面的示例代码中，你是直接把代理填写到代码里面的。如果我需要访问某个 URL 来获取新的代理怎么办呢？其实这也很简单，你可以再安装一个第三方模块：<code>axios</code>用来发起网络请求获取新的代理 IP，然后再替换:</p> <p>还是以青果云的短效代理 IP 为例，它可以提供一个接口，访问接口后，你能得到一个有效期5-15分钟的短效 IP，如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-12-19-11-29-14.png"/></p> <p>开通试用账号以后，你可以获得一个提取代理的 URL，类似于下面这样：</p> <p>访问以后就能拿到代理IP，如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-12-19-11-34-37.png"/></p> <p>现在，我们要在 Puppeteer 里面，先访问这个 URL 获取代理，再把代理IP 设置到 Puppeteer 中，然后再访问目标网页。对应的代码如下：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-12-19-11-49-40.png"/></p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    