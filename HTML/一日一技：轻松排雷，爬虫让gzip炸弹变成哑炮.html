 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>在昨天的文章《<a href="https://mp.weixin.qq.com/s/Lzo6Pm09XsOqPkz3O91Mgg" rel="noopener" target="_blank">一日一技：反爬虫的极致手段，几行代码直接炸了爬虫服务器</a>》中，我讲到了后端如何使用gzip返回极高压缩率的文件，从而瞬间卡死爬虫。</p> <p>大家都知道我的公众号风格，要<del>得罪</del>讨好就两边一起<del>得罪</del>讨好。昨天我帮了后端，今天我就帮帮爬虫。作为爬虫，如何避免踩中gzip炸弹？</p> <p>最直接的方法，就是把你的爬虫隐藏起来，因为gzip炸弹只能在发现了爬虫以后使用，否则就会影响到正常用户。只要你的爬虫让网站无法发现，那么自然就不会踩中炸弹。</p> <p>如果你没有把握隐藏爬虫，那么，请继续往下看。</p> <p>查看gzip炸弹的URL返回的Headers，你会发现如下图所示的字段：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220125184230.png"/></p> <p>你只需要判断<code>resp.headers</code>中，是否有一个名为<code>content-encoding</code>，值包含<code>gzip</code>或<code>deflate</code>的字段。如果没有这个字段，或者值不含<code>gzip</code>、<code>deflate</code>那么你就可以放心，它大概率不是炸弹。</p> <p>值得一提的是，当你不读取<code>resp.content</code>、<code>resp.text</code>的时候，Requests是不会擅自给你解压缩的，如下图所示。因此你可以放心查看Headers。：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220125184347.png"/></p> <p>那么，如果你发现网站返回的内容确实是<code>gzip</code>压缩后的内容了怎么办呢？这个时候，我们如何做到既不解压缩，又能获取到解压以后的大小？</p> <p>如果你本地检查一个<code>.gz</code>文件，那么你可以使用命令<code>gzip -l xxx.gz</code>来查看它的头信息：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220125184943.png"/></p> <p>打印出来的数据中，第一个数字是压缩后的大小，第二个数字是解压以后的大小，第三个百分比是压缩率。这些信息是储存在压缩文件的头部信息中的，不用解压就能获取到。</p> <p>那么当我使用Requests的时候，如何获得压缩后的二进制数据，防止它擅自解压缩？方法其实非常简单：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220125185246.png"/></p> <p>此时可以看到，这个大小是压缩后的二进制数据的大小。现在，我们可以使用如下代码，在不解压的情况下，查询到解压缩后的文件大小：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220125185700.png"/></p> <p>打印出来的数字转成MB就是10MB，也就是我们昨天测试的解压后的文件大小。</p> <p>使用这个方法，我们就可以在不解压的情况下，知道网站返回的gzip压缩数据的实际大小。如果发现实际尺寸大得离谱，那就可以确定是gzip炸弹了，赶紧把它丢掉。</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    