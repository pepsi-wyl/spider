 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>在上一篇文章<a href="http://kingname.info/2014/12/30/%E4%BD%BF%E7%94%A8AWS%E4%BA%9A%E9%A9%AC%E9%80%8A%E4%BA%91%E6%90%AD%E5%BB%BAGmail%E8%BD%AC%E5%8F%91%E6%9C%8D%E5%8A%A1/" rel="noopener" target="_blank">使用AWS亚马逊云搭建Gmail转发服务（一）</a>中，我们介绍了如何在亚马逊AWS的免费主机EC2中使用Gmai API从而接收邮件的操作。在这篇文章中，将要讲解如何制作一个邮件转发服务。</p> <p>我之前有写一篇文章，<a href="http://kingname.info/2014/12/23/A-Totally-Amazing/" rel="noopener" target="_blank">使用微信控制你的电脑</a>其中有讲解如何使用Python的smtplib库实现发送邮件。于是Gmail邮件转发的思路就出来了：</p> <p>程序定期检查Gmail邮箱，如果发现有新的邮件，就将新邮件的标题，发送人，还有邮件正文提取出来，并使用 MIMEText构造一个邮件的object 然后再用国内邮箱发送给自己的主邮箱。</p> <p>这里涉及到三个邮箱：Gmail，国内邮箱一（发送），国内邮箱二（接收）。其中国内邮箱二是我的常用邮箱，我将它和微信绑定，因此一旦有新邮件，就会收到提醒。国内邮箱一是一个备胎邮箱，他的作用就是一个转发而已。</p> <p>可能有人会问为什么不用Gmail直接转发？因为我觉得很有可能不久以后，Gmail发送的邮件，国内邮箱收不到。</p> <p>那么我们将<a href="http://kingname.info/2014/12/23/A-Totally-Amazing/" rel="noopener" target="_blank">使用微信控制你的电脑</a>这篇文章中涉及到的auto.py进行修改，编写一个ghelper_sender.py：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/></pre></td><td class="code"><pre><span class="line">#-*-coding:utf-8 -*-</span><br/><span class="line"></span><br/><span class="line">import smtplib</span><br/><span class="line">import sys</span><br/><span class="line">from email.mime.text import MIMEText</span><br/><span class="line"></span><br/><span class="line">reload(sys)</span><br/><span class="line">sys.setdefaultencoding('utf-8')</span><br/><span class="line"></span><br/><span class="line">username = "<a class="__cf_email__" data-cfemail="ecdddedfac9f85828dc28f8381" href="/cdn-cgi/l/email-protection">[email protected]</a>"# 接收邮箱</span><br/><span class="line">password = "123abc"# 接收邮箱密码</span><br/><span class="line">mailbox = "<a class="__cf_email__" data-cfemail="7c1b0e1919120f130908143c1a1304111d1510521f1311" href="/cdn-cgi/l/email-protection">[email protected]</a>" #国内邮箱二</span><br/><span class="line"></span><br/><span class="line">def send_mail(subjectbody='Success'):</span><br/><span class="line">        msg = MIMEText(body'plain''utf-8')#中文需参数‘utf-8’，单字节字符不需要</span><br/><span class="line">        msg['Subject'] = subject</span><br/><span class="line">        msg['from'] = username</span><br/><span class="line">        handle = smtplib.SMTP('smtp.sina.com' 25)</span><br/><span class="line">        handle.login(usernamepassword)</span><br/><span class="line">		handle.sendmail(usernamemailbox msg.as_string())</span><br/><span class="line">        handle.close()</span><br/></pre></td></tr></table></figure></p> <p>这里需要注意，msg[‘from’] 的值必须是国内邮箱一，而不是发邮件到Gmail邮箱的那个地址，否则会报错。</p> <p>现在打开上一篇文章中的ghelper_api.py，在最开头添加：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">from ghelper_sender import send_mail</span><br/></pre></td></tr></table></figure></p> <p>导入send_mail函数。</p> <p>由于ghelper_api.py 中，上一篇文章中通过<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">a = ListMessagesWithLabels(gmail_service'me')[0]['id']</span><br/><span class="line">b = GetMessage(gmail_service'me'a)</span><br/></pre></td></tr></table></figure></p> <p>获得你邮件的正文和发件人，现在再获取邮件的标题：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">subject = b['payload']['headers'][12]['value']</span><br/></pre></td></tr></table></figure></p> <p>这里我把发件人和邮件正文添加到一起，于是得到以下代码：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/></pre></td><td class="code"><pre><span class="line">a = ListMessagesWithLabels(gmail_service'me')[0]['id']</span><br/><span class="line">b = GetMessage(gmail_service'me'a)</span><br/><span class="line">content =  b['snippet']</span><br/><span class="line">sender =  b['payload']['headers'][3]['value']</span><br/><span class="line">subject = b['payload']['headers'][12]['value']</span><br/><span class="line">body = sender + '\n' + content</span><br/><span class="line">send_mail(subjectbody)</span><br/><span class="line">print subject</span><br/><span class="line">print body</span><br/><span class="line">print '============================'</span><br/></pre></td></tr></table></figure></p> <p>这样就能发送一次邮件了。接收到的效果如图：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmailmail.jpg"/><br/>但是这显然不是我们需要的效果。我们希望这个程序能够自动运行，自动查看邮箱。于是，编写一个函数isnew()来检测是否有新的邮件发送过来，如果有就获取新邮件并发送。</p> <p>设定一个全局变量last_email用于保存已读的最后一封邮件，令他的初始化为当前邮箱里面最新的一封邮件的id.接下来每过一段时间，程序就检查邮箱里面邮件的id，如果和last_email相同，就什么都不做；如果不相同，则程序就读取邮件，直到读取到某一封邮件的id和last_email相同为止。再令last_email的值为当前最新的id.代码如下：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/></pre></td><td class="code"><pre><span class="line">def init():</span><br/><span class="line">  global last_email</span><br/><span class="line">  last_email = ListMessagesWithLabels(gmail_service'me')[0]['id']</span><br/><span class="line"></span><br/><span class="line">def isnew():</span><br/><span class="line">  global last_email</span><br/><span class="line">  themail = ListMessagesWithLabels(gmail_service'me')</span><br/><span class="line">  for each in themail:</span><br/><span class="line">    if each['id'] != last_email:</span><br/><span class="line">      tosend(each['id'])</span><br/><span class="line">    else:</span><br/><span class="line">      break</span><br/><span class="line">  last_email = themail[0]['id']</span><br/><span class="line"></span><br/><span class="line">def tosend(id):</span><br/><span class="line">  b = GetMessage(gmail_service'me'id)</span><br/><span class="line">  content =  b['snippet']</span><br/><span class="line">  sender =  b['payload']['headers'][3]['value']</span><br/><span class="line">  subject = b['payload']['headers'][12]['value']</span><br/><span class="line">  body = sender + '\n' + content</span><br/><span class="line">  send_mail(subjectbody)</span><br/><span class="line">  print subject</span><br/><span class="line">  print body</span><br/><span class="line">  print '============================'</span><br/></pre></td></tr></table></figure></p> <p>设定一个主函数，并把上面的代码放在主函数里面并循环执行：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">if __name__=='__main__':</span><br/><span class="line">    init()</span><br/><span class="line">    while 1:</span><br/><span class="line">        time.sleep(3600) #每一小时检查一次邮箱</span><br/><span class="line">        isnew()</span><br/></pre></td></tr></table></figure></p> <p>完整的代码我放在了Github上面，请戳-&gt;<a href="https://github.com/kingname/MCC/tree/master/ghelper" rel="noopener" target="_blank">https://github.com/kingname/MCC/tree/master/ghelper</a></p> <p>在下一篇文章中，将介绍Python的logging库，并将每次的发送记录通过日志记录下来。同时用Flask搭建一个网站，从而方便直观的检查这个程序的运行情况。</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    