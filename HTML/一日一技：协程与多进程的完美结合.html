 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>我们知道，协程本质上是单线程单进程，通过充分利用IO等待时间来实现高并发。在IO等待时间之外的代码，还是串行运行的。因此，如果协程非常多，多少每个协程内部的串行代码运行时间超过了IO请求的等待时间，那么它的并发就会有一个上限。</p> <p>举个例子，电饭煲煮饭，洗衣机洗衣服，热水壶烧水，他们都是启动设备以后就能自己运行，我们可以利用他们自己运行的时间，让这三件事情看起来几乎在同时进行。但如果除了这三件事情外，还有开电视，开空调，发微信……等等几十个事情。每个事情单独拿出来确实都只需要做个开头，剩下的就是等，但由于做这个开头也需要时间，因此把他们全部启动起来也要不少时间，你的效率还是被卡住。</p> <p>现在，如果有两个人一起来做这些事情，那情况就不一样了。一个人煮饭和烧水，另一个人开洗衣机，开电视和空调。效率进一步提升。</p> <p>这就是协程与多进程的结合，每个进程里面多个协程同时运行，充分利用CPU的每一个核心，又充分利用了IO等待时间，把CPU跑满，把网络带宽跑满。强强联合，速度更快。</p> <p>有一个第三方库<code>aiomultiprocess</code>，让你能用几行代码就实现多进程与协程的组合。</p> <p>首先使用pip安装：</p> <p>它的语法非常简单：</p> <p>只需要3行代码，它就会在你CPU上每个核启动一个进程，每个进程中不停启动协程。</p> <p>我们来写一段实际代码：</p> <p>之前我写异步协程文章的时候，有些人同学会问我，爬虫的速度真的那么重要吗？难道不是突破反爬虫最重要吗？</p> <p>我的回答是，不要看到用aiohttp请求网址就觉得是做爬虫。在微服务里面，自己请求自己的HTTP接口，也需要使用httpx或者aiohttp。在这样的场景里面，速度就是非常的重要，有时候就是需要做到越快越好。</p> <p>关于<code>aiomultiprocess</code>的更多使用，可以参阅它的<a href="https://aiomultiprocess.omnilib.dev/en/latest/guide.html" rel="noopener" target="_blank">官方文档</a>.</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    