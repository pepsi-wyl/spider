 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>在上一篇文章<a href="http://kingname.info/2014/12/31/%E4%BD%BF%E7%94%A8%E4%BA%9A%E9%A9%AC%E9%80%8A%E4%BA%91AWS%E6%90%AD%E5%BB%BAGmail%E9%82%AE%E4%BB%B6%E8%BD%AC%E5%8F%91%E6%9C%8D%E5%8A%A1%E4%BA%8C/" rel="noopener" target="_blank">使用AWS亚马逊云搭建Gmail转发服务（二）</a>中，我们已经介绍了如何把邮件转发程序部署在服务器上。但是这样还不够。还需要实时监控程序的运行状态。于是，给程序增加日志记录功能是非常重要的。</p> <p>这里使用Python的logging库，实现日志记录功能。<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line">import logging</span><br/><span class="line"></span><br/><span class="line">logging.basicConfig(level=logging.DEBUG</span><br/><span class="line">                format='%(asctime)s %(filename)s %(levelname)s %(message)s'</span><br/><span class="line">                datefmt='%Y %m %d %H:%M:%S' #日期格式：年月日时分秒</span><br/><span class="line">                filename='mail_note.log' #文件名</span><br/><span class="line">                filemode='a') #以最佳的方式添加日志</span><br/><span class="line">mail_log = logging.getLogger('maillog')</span><br/></pre></td></tr></table></figure></p> <p>以上代码的作用是导入logging库功能。然后配置logging的输出格式。<br/>各行代码的作用已经注释。</p> <p>要使用日志的时候，通过以下代码：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">logging.info('日志内容')</span><br/></pre></td></tr></table></figure></p> <p>同类的还有:<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">mail_log.debug('内容')</span><br/><span class="line">mail_log.warning('内容')</span><br/><span class="line">mail_log.error('内容')</span><br/><span class="line">……</span><br/></pre></td></tr></table></figure></p> <p>logging库的功能还有很多，这里只是简单的介绍一下，更多的功能可以查阅相关的资料。</p> <p>现在日志已经生成。又如何通过Flask查看呢？由于我的前端不行。因此这里就不使用精细的模板了。Flask的部署就不叙述了，各位可以参考Flask官方文档<a href="https://dormousehole.readthedocs.org/en/latest/" rel="noopener" target="_blank">http://dormousehole.readthedocs.org/en/latest/</a></p> <p>这里我只演示一个非常简单的日志输出功能。编写gmail_flask.py请看代码：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/></pre></td><td class="code"><pre><span class="line">#-*-coding:utf-8-*-</span><br/><span class="line">from flask import Flask</span><br/><span class="line">app = Flask(__name__)</span><br/><span class="line"></span><br/><span class="line">@app.route('/')</span><br/><span class="line">def index():</span><br/><span class="line">    f = open('mail_note.log''rb') #以读文件的方式打开mail_note.log文件</span><br/><span class="line">    content = f.readlines()#按行读取日志</span><br/><span class="line">    s = ''</span><br/><span class="line">    for each in content:</span><br/><span class="line">        s += each</span><br/><span class="line">        s += '&lt;/p&gt;'#输出日志</span><br/><span class="line">    f.close()</span><br/><span class="line">    return s</span><br/><span class="line"></span><br/><span class="line">if __name__ == '__main__':</span><br/><span class="line">    app.run(host='0.0.0.0') #开发外网访问</span><br/></pre></td></tr></table></figure></p> <p>这个功能是把日志按行输出到网页上。<br/>现在测试一下功能：<br/>在终端窗口输入：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">screen</span><br/><span class="line">python gmail_helper.py</span><br/></pre></td></tr></table></figure></p> <p>然后Ctrl+A+D返回，再输入：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">screen</span><br/><span class="line">python gmail_flask.py</span><br/></pre></td></tr></table></figure></p> <p>然后访问服务器的5000端口查看效果。如图是我的服务器返回信息：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmailmaillog.jpg"/></p> <p>这里出现了Google的很多信息，这是由于Gmail的API库文件discovery.py里面也有用到日志功能。这个时候这里调用根logging，就会把discovery.py里面logging.info输出的信息写出来。这个时候怎么办呢？我对logging不是很熟悉，还请熟悉logging模块的朋友指点迷津。</p> <p>我使用了一个变通的办法：</p> <p>修改gmail_flask.py文件：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/></pre></td><td class="code"><pre><span class="line">#-*-coding:utf-8-*-</span><br/><span class="line">from flask import Flask</span><br/><span class="line">app = Flask(__name__)</span><br/><span class="line"></span><br/><span class="line">@app.route('/')</span><br/><span class="line">def index():</span><br/><span class="line">    f = open('mail_note.log''rb') #以读文件的方式打开mail_note.log文件</span><br/><span class="line">    content = f.readlines()#按行读取日志</span><br/><span class="line">    s = ''</span><br/><span class="line">    for each in content:</span><br/><span class="line">		if 'gmail_helper.py' in each: #判定信息来自gmail_helper.py而不是discovery.py</span><br/><span class="line">	        s += each</span><br/><span class="line">	        s += '&lt;/p&gt;'#输出日志</span><br/><span class="line">    f.close()</span><br/><span class="line">    return s</span><br/><span class="line"></span><br/><span class="line">if __name__ == '__main__':</span><br/><span class="line">    app.run(host='0.0.0.0') #开发外网访问</span><br/></pre></td></tr></table></figure></p> <p>效果如下图：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmailmaillog2.jpg"/></p> <p>源代码已更新到Github，请戳-&gt;<a href="https://github.com/kingname/MCC/blob/master/ghelper_with_log" rel="noopener" target="_blank">https://github.com/kingname/MCC/blob/master/ghelper_with_log</a></p> <p>我的日志会通过博客进行开放，地址请戳：</p> <p><a href="http://flask.kingname.info:5000" rel="noopener" target="_blank">http://flask.kingname.info:5000</a></p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    