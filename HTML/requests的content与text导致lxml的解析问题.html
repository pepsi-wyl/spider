 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>最近实习工作任务比较重，又在做数据挖掘的教学工作，同时还在做毕设，所以博客更新比较慢。不过最近肯定会有大动作。</p> <p>闲话毕，转正题。在制作新浪微博模拟登录的部分时，遇到了一些问题。</p> <p>我使用requests获取了新浪微博的源代码，通过lxml库的etree.HTML来处理一段网页源代码，从而生成一个可以被xpath解析的对象。<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">selector = etree.HTML(html)</span><br/></pre></td></tr></table></figure></p> <p>遇到报错：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">selector = etree.HTML(html)</span><br/><span class="line">  File "lxml.etree.pyx" line 2953 in lxml.etree.HTML (src\lxml\lxml.etree.c:66734)</span><br/><span class="line">  File "parser.pxi" line 1780 in lxml.etree._parseMemoryDocument (src\lxml\lxml.etree.c:101591)</span><br/><span class="line">ValueError: Unicode strings with encoding declaration are not supported. Please use bytes input or XML fragments without declaration.</span><br/></pre></td></tr></table></figure></p> <p>根据报错信息推测，可能是因为不支持编码声明的Unicode字符串。Google发现这个问题在2012年就已经有人提交给作者了，但是一直没有被修复。地址在-&gt;<a href="https://gist.github.com/karlcow/3258330" rel="noopener" target="_blank">https://gist.github.com/karlcow/3258330</a></p> <p>不过下面的人也给出了解决办法：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">html = bytes(bytearray(html encoding='utf-8'))</span><br/><span class="line">selector = etree.HTML(html)</span><br/></pre></td></tr></table></figure></p> <p>首先将源代码转化成比特数组，然后再将比特数组转化成一个比特对象。这样就可以绕过这个bug。</p> <p>然而，又有人认为这不是一个bug 所以一直没有被修复。这是由于，我获取源代码是使用r.text<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">html = requests.get('xxxxxx'cookies=cookies).text</span><br/></pre></td></tr></table></figure></p> <p>而如果使用r.content：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">html = requests.get('xxxxxx'cookies=cookies).content</span><br/></pre></td></tr></table></figure></p> <p>就不会报错。</p> <p>那r.text与r.content有什么区别呢？分析requests的源代码发现，r.text返回的是Unicode型的数据，而使用r.content返回的是bytes型的数据。也就是说，在使用r.content的时候，他已经只带了<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">html = bytes(bytearray(html encoding='utf-8'))</span><br/></pre></td></tr></table></figure></p> <p>这样一个转化了。</p> <p>最近CentOS都声明放弃Python2了，编码问题确实浪费了很多时间，等空下来转Python3吧~</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    