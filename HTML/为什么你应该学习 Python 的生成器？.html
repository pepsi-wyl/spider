 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>写过一段时间代码的同学，应该对这一句话深有体会：程序的时间利用率和空间利用率往往是矛盾的，可以用时间换空间，可以用空间换时间，但很难同时提高一个程序的时间利用率和空间利用率。</p> <p>但如果你尝试使用生成器来重构你的代码，也许你会发现，在一定程度上，你可以既提高时间利用率，又提高空间利用率。</p> <p>我们以一个数据清洗的简单项目为例，来说明生成器如何让你的代码运行起来更加高效。</p> <p>在 Redis 中，有一个列表<code>datalist</code>，里面有很多的数据，这些数据可能是<code>纯阿拉伯数字</code>，<code>中文数字</code>，<code>字符串"敏感信息"</code>。现在我们需要实现：从 Redis 中读取所有的数据，把所有的字符串<code>敏感信息</code>全部丢掉，把所有中文数字全部转换为阿拉伯数字，以<code>{'num': 12345 'date': '2019-10-30 18:12:14'}</code>这样的格式插入到 MongoDB 中。</p> <p>示例数据如下：</p> <p>如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-10-30-19-27-35.png"/></p> <p>如果让你来写这个转换程序，你可能会这样写：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-10-30-19-45-36.png"/></p> <p>这段代码，看起来很 Pythonic，一个函数只做一件事，看起来也满足编码规范。最后运行结果也正确。能有什么问题？</p> <p>问题在于，这段代码，每个函数都会创建一个列表存放处理以后的数据。如果 Redis 中的数据多到超过了你当前电脑的内存怎么办？对同一批数据多次使用 for 循环，浪费了大量的时间，能不能只循环一次？</p> <p>也许你会说，你可以把移除<code>敏感信息</code>，中文数字转阿拉伯数字的逻辑全部写在<code>get_data</code>函数的 <code>while</code>循环中，这样不就只循环一次了吗？</p> <p>可以是可以，但是这样一来，<code>get_data</code>就做了不止一件事情，代码也显得非常混乱。如果以后要增加一个新的数据处理逻辑：</p> <p>转换为数字以后，检查所有奇数位的数字相加之和与偶数位数字相加之和是否相等，丢弃所有相等的数字。</p> <p>那么你就要修改<code>get_data</code>的代码。</p> <p>在开发软件的时候，我们应该面向扩展开放，面向修改封闭，所以不同的逻辑，确实应该分开，所以上面把每个处理逻辑分别写成函数的写法，在软件工程上没有问题。但是如何做到处理逻辑分开，又不需要对同一批数据进行多次 for 循环呢？</p> <p>这个时候，就要依赖于我们的生成器了。</p> <p>我们先来看看下面这一段代码的运行效果：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-10-30-20-04-14.png"/></p> <p>现在，我们对代码做一下修改：</p> <p>其运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-10-30-20-05-33.png"/></p> <p>大家对比上面两张插图。前一张插图，先生成10个数据，然后再打印10个数据。后一张图，生成一个数据，打印一个数据，再生成一个数据，再打印一个数据……</p> <p>如果以代码的行号来表示运行运行逻辑，那么代码是按照这个流程运行的：</p> <p>大家可以把这段代码写在 PyCharm 中，然后使用单步调试来查看它每一步运行的是哪一行代码。</p> <p>程序运行到<code>yield</code>就会把它后面的数字<code>抛出</code>到外面给 for 循环， 然后进入外面 for 循环的循环体，外面的 for 循环执行完成后，又会进入<code>gen_num</code>函数里面的 <code>yield i</code>后面的一行，开启下一次 for 循环，继续生成新的数字……</p> <p>整个过程中，不需要额外创建一个列表来保存中间的数据，从而达到节约内存空间的目的。而整个过程中，虽然代码写了两个 for 循环，但是如果你使用单步调试，你就会发现实际上真正的循环只有<code>for i in range(10)</code>。而外面的<code>for num in nums</code>仅仅是实现了函数内外的切换，并没有新增循环。</p> <p>回到最开始的问题，我们如何使用生成器来修改代码呢？实际上你几乎只需要把<code>return 列表</code>改成<code>yield 每一个元素</code>即可：</p> <p>代码如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-10-30-20-21-57.png"/></p> <p>如果你开启 PyCharm 调试模式，你会发现，数据的流向是这样的：</p> <p>整个过程就像是一条流水线一样，数据一条一条地进行处理和存档。不需创建额外的列表，有多少条数据就循环多少次，不做多余的循环。</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    