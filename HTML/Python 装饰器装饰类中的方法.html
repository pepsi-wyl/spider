 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>目前在中文网上能搜索到的绝大部分关于装饰器的教程，都在讲如何装饰一个普通的函数。本文介绍如何使用Python的装饰器装饰一个类的方法，同时在装饰器函数中调用类里面的其他方法。本文以捕获一个方法的异常为例来进行说明。</p> <p>有一个类Test 它的结构如下：</p> <p>在类中有一个方法<code>read_value()</code>，这个方法在多个地方被调用。由于某些原因，方法<code>read_value</code>有可能随机抛出Exception导致程序崩溃。所以需要对整个方法做<code>try ... except</code>处理。最丑陋的做法如下面的代码所示：</p> <p>这样写虽然可以解决问题，但是代码不Pythonic。</p> <p>使用装饰器来解决这个问题，装饰器函数应该写在类里面还是类外面呢？答案是，写在类外面。那么既然写在类外面，如何调用这个类的其他方法呢？</p> <p>首先写出一个最常见的处理异常的装饰器：</p> <p>这种写法，确实可以捕获到<code>origin_func()</code>的异常，但是如果在发生异常的时候，需要调用类里面的另一个方法来处理异常，这又应该怎么办？答案是给wrapper增加一个参数：self.</p> <p>代码变为如下形式：<br/><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">catch_exception</span><span class="params">(origin_func)</span>:</span></span><br/><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(self *args **kwargs)</span>:</span></span><br/><span class="line">        <span class="keyword">try</span>:</span><br/><span class="line">            u = origin_func(self *args **kwargs)</span><br/><span class="line">            <span class="keyword">return</span> u</span><br/><span class="line">        <span class="keyword">except</span> Exception:</span><br/><span class="line">            self.revive() <span class="comment">#不用顾虑，直接调用原来的类的方法</span></span><br/><span class="line">            <span class="keyword">return</span> <span class="string">'an Exception raised.'</span></span><br/><span class="line">    <span class="keyword">return</span> wrapper</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span><span class="params">(object)</span>:</span></span><br/><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br/><span class="line">        <span class="keyword">pass</span></span><br/><span class="line"></span><br/><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">revive</span><span class="params">(self)</span>:</span></span><br/><span class="line">        print(<span class="string">'revive from exception.'</span>)</span><br/><span class="line">        <span class="comment"># do something to restore</span></span><br/><span class="line"></span><br/><span class="line"><span class="meta">    @catch_exception</span></span><br/><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_value</span><span class="params">(self)</span>:</span></span><br/><span class="line">        print(<span class="string">'here I will do something.'</span>)</span><br/><span class="line">        <span class="comment"># do something.</span></span><br/></pre></td></tr></table></figure></p> <p>只需要修改装饰器<strong>定义</strong>的部分，使用装饰器的地方完全不需要做修改。</p> <p>下图为正常运行时的运行结果：<br/><img alt="正常运行" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2017-04-17-21-19-25.png"/></p> <p>下图为发生异常以后捕获并处理异常：<br/><img alt="发生异常" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2017-04-17-21-20-59.png"/></p> <p>通过添加一个self参数，类外面的装饰器就可以直接使用类里面的各种方法，也可以直接使用类的属性。</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    