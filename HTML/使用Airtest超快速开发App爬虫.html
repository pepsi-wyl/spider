 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>想开发网页爬虫，发现被反爬了？想对 App 抓包，发现数据被加密了？不要担心，使用 Airtest 开发 App 爬虫，只要人眼能看到，你就能抓到，最快只需要2分钟，兼容 Unity3D、Cocos2dx-*、Android 原生 App、iOS App、Windows Mobile……。</p> <p>Airtest是网易开发的手机UI界面自动化测试工具，它原本的目的是通过所见即所得，截图点击等等功能，简化手机App图形界面测试代码编写工作。</p> <p>爬虫开发本着天下工具为我所用，能让我获取数据的工具都能用来开发爬虫这一信念，决定使用Airtest来开发手机App爬虫。</p> <p>由于本文的目的是介绍如何使用Airtest来开发App爬虫，那么Airtest作为测试开发工具的方法介绍将会一带而过，仅仅说明如何安装并进行基本的操作。</p> <p>从Airtest官网：<a href="https://airtest.netease.com" rel="noopener" target="_blank">https://airtest.netease.com</a>下载Airtest，然后像安装普通软件一样安装即可。安装过程没有什么需要特别说明的地方。Airtest已经帮你打包好了开发需要的全部环境，所以安装完成Airtest以后就能够直接使用了。</p> <p>Airtest运行以后的界面如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-13-10-30.png"/></p> <p>以Android手机为例，由于Airtest会通过adb命令安装两个辅助App到手机上，再用adb命令通过控制这两个辅助App进而控制手机，因此首先需要确保手机的<code>adb调试</code>功能是打开的，并允许通过adb命令安装App到手机上。</p> <p>启动Airtest以后，把Android手机连接到电脑上，点击下图方框中的<code>refresh ADB</code>：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-13-16-45.png"/></p> <p>此时在Airtest界面右上角应该能够看到手机的信息，如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-13-17-51.png"/></p> <p>点击<code>connect</code>按钮，此时可以在界面上看到手机的界面，并且当你手动操作手机屏幕时，Airtest中的手机画面实时更新。如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-13-21-40.png"/></p> <p>对于某些手机，例如小米，在第一次使用Airtest时，请注意手机上将会弹出提示，询问你是否允许安装App，此时需要点击允许按钮。</p> <p>先通过一个简单的例子，来看看如何快速上手Airtest，稍后再来详解。</p> <p>例如我现在想使用电脑控制手机，打开微信。</p> <p>此时，点击下图中方框框住的<code>touch</code>按钮：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-13-27-32.png"/></p> <p>此时，把鼠标移动到Airtest右边的手机屏幕区域，鼠标会变成十字型。在微信图标的左上角按下鼠标左键不放，并拖到微信右下角松开鼠标。此时请注意中间代码区域发生了什么变化，如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-13-30-15.png"/></p> <p>好了。以上就是你需要使用电脑打开微信所要进行的全部操作。</p> <p>点击上方工具栏中的三角形图标，运行代码，如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-13-32-29.png"/></p> <p>代码运行完成以后，微信被打开了。</p> <p>在有了一个直观的使用以后，我们再来介绍一下Airtest的界面，将会更加有针对性。</p> <p>Airtest的界面如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-14-04-37.png"/></p> <p>这里，我把Airtest分成了A-F6个区域，他们的功能如下：</p> <p>A区是常用的<code>基于图像识别</code>的屏幕操作功能，例如：</p> <p>一般来说，是点击A区里面的某一个功能，然后在D区屏幕上进行框选操作，B区就会自动生成相应的操作代码。</p> <p>B区用来显示和编写Python代码。在多数情况下，不需要手动写代码，因为代码会根据你在手机屏幕上面的操作自动生成。只有一些需要特别定制化的动作才需要修改代码。</p> <p>D区显示了手机屏幕，当你操作手机真机时，这个屏幕会实时刷新。你也可以直接在D区屏幕上使用鼠标操作手机，你的操作动作会被自动在真机上执行。</p> <p>F区是一些常用工具，从左到右，依次为：</p> <p>其中1-5很好理解，那么什么是查看运行报告呢？</p> <p>当你至少运行了一次以后，点击这个功能，会自动给你打开一个网页。网页如下图所示，这是你的代码的运行报告，详细到每一步操作了什么元素。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/launch_report.png"/></p> <p>通过截图功能操作手机虽然方便，但是截图涉及到分辨率的问题，代码不能在不同的手机上通用。所以对于A区的功能，做点简单操作即可，不用深入了解。</p> <p>更高级的功能，需要通过E区实现。</p> <p>App的布局信息就像网页的HTML一样，保存了App上面各个元素的相对位置和各个参数。对于一个App而言，在不同分辨率的手机上，可能相同的元素有着不同的坐标点，但是这个元素的属性参数一般是不会变的。因此，如果使用元素的属性参数来寻找并控制这个元素，就能实现在不同分辨率手机上的精确定位。</p> <p>App的布局信息的格式与App的开发环境有关。点击F区的下拉菜单，可以看到这里能够指定不同的App开发环境。其中的<code>Unity</code>、<code>Cocos-*</code>等等一般是做游戏用的，<code>Android</code>是安卓原生App，<code>iOS</code>是苹果的App……如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-14-17-32.png"/></p> <p>以手机版知乎为例，由于它是Android原生的App，所以在F区下拉菜单选择<code>Android</code>，此时注意B区弹出提示，询问你是否要插入poco初始代码到当前输入光标的位置，点击<code>Yes</code>，如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-14-25-17.png"/></p> <p>此时，B区自动插入了一段代码，如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-14-27-11.png"/></p> <p>现在，点击E区的锁形图标，如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-14-39-30.png"/></p> <p>锁形图标激活以后，你再操作D区的屏幕，点击<code>知乎</code>App下面的<code>知乎</code>两个字，会发现屏幕上被点击的App并不会打开。但E区和C区却发生了变化，如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-14-45-24.png"/></p> <p>其中E区显示的树状结构就是当前屏幕的布局信息，这与Chrome开发者工具里面显示的HTML结构如出一辙。C区显示的是当前被我点中的元素的信息。</p> <p>请注意在这些元素信息中，有一个<code>text</code>属性，它的值为<code>知乎</code>。那么，这个属性就可以作为一个定位元素，于是可以在B区编写代码：</p> <p>写完代码以后运行程序，可以看到知乎App被打开了。如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-14-48-47.png"/></p> <p>注意，如果你发现手机真机显示的界面与Airtest屏幕显示的手机界面不一致，可能是因为Airtest的屏幕被你锁定了。在F区点一下锁形图标，取消锁定，Airtest中的手机屏幕就会更新了。</p> <p>打开知乎以后，我想使用知乎的搜索功能，那么继续，把锁形图标激活，然后点击知乎顶部的搜索框，如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-15-06-41.png"/></p> <p>继续看C区显示的搜索框属性，可以看到这里有一个<code>name</code>属性，它的值是<code>com.zhihu.android:id/input</code>，还有一个<code>text</code>属性，它的值为<code>蔡徐坤任 NBA 新春贺岁大使</code>。能不能像前面打开知乎一样，使用<code>text</code>这个属性呢？也行，也不行。说它行，是因为你这么做确实现在能工作；说它不行，因为这是知乎的热门搜索关键词，随时会改变。你今天使用这一句话成功了，明天热门关键词变化了，那么你的代码就无法使用了。所以此时需要使用<code>name</code>这个属性。</p> <p>常见的基本上不会变化的属性包含但不限于：<code>name</code> <code>type</code> <code>resourceId</code> <code>package</code>。</p> <p>另外还有一点，知乎首页的这个搜索框，实际上是不能输入内容的，当你点击以后，会跳转到另一个页面，如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-15-11-17.png"/></p> <p>因此你需要先点击一下这个输入框，跳转到真正的搜索界面：</p> <p>在真正的搜索界面如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-15-12-50.png"/></p> <p>可以看到，<code>name</code>属性的值依然是<code>com.zhihu.android:id/input</code>，此时就可以输入内容了。</p> <p>输入内容使用的方法为<code>set_text</code>，用法为：</p> <p>输入了搜索关键词以后，再来看看当前页面，搜索出现了三个结果：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-15-17-58.png"/></p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-15-18-36.png"/></p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-15-19-14.png"/></p> <p>通过对比这三个结果的属性信息，发现他们的<code>name</code>属性都是相同的，而<code>text</code>不同。如果像下面这样写点击动作：</p> <p>那么默认就会点击第一个搜索结果。</p> <p>如果我想点击第二个搜索结果怎么办呢？可以这样写代码：</p> <p>或者你也可以像列表一样使用索引定位：</p> <p>这两种写法的前提，都是我们已经知道了每个结果分别是什么。假设现在我就想搜索<code>古剑奇谭三</code>，但我不知道搜索结果是第几项，又应该怎么办呢？此时还可以使用正则表达式：</p> <p>进入搜索结果以后，需要查看下面的各种问题，此时就需要不断向上滑动屏幕。这里有一点需要特别注意，Airtest只能获取当前屏幕上的元素布局信息，不在屏幕上的内容是无法获取的。这一点和Selenium是不一样的。</p> <p>滑动屏幕使用的命令为<code>swipe</code>，滑动屏幕需要使用坐标信息。但这种坐标和屏幕分辨率无关。这里的<code>坐标</code>定义为：(x y)，其中x为横坐标，y为纵坐标。屏幕左上角为(0 0)，屏幕右下角为(1 1)，从左向右，横坐标从0逐渐增大到1，从上到下，纵坐标从0逐渐增大到1。</p> <p>现在我要把屏幕向上滑动，那么在真机上面，我是先按住屏幕下方，然后把屏幕向上滑动，所以代码可以这样写：</p> <p>方向示意图如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-15-42-43.png"/></p> <p>在一般情况下：</p> <p>在爬虫开发中，涉及到的Airtest操作基本上已经介绍完毕。</p> <p>在Airtest操作手机虽然方便，但是不可能在每一台电脑上都安装Airtest吧。所以需要想办法把代码从Airtest这个程序中分离出来。</p> <p>Airtest基于Python的一个开源库Poco开发，而在Airtest的B区写的Python代码，实际上就是Poco的代码。所以只要安装Poco库，就可以在Python中直接控制手机。</p> <p>安装Poco库的命令为：</p> <p>这个库依赖的东西有点多，安装稍稍慢一些。安装完成以后，我们把代码复制到PyCharm中，如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-16-59-52.png"/></p> <p>运行这段代码，如果是Linux或者macOS的用户，请注意看运行结果是不是有报错，提示adb没有运行权限。这是因为随Poco安装的adb没有运行权限，需要给它添加权限，在终端执行命令：</p> <p>命令运行完成以后再次执行代码，可以看到代码运行成功，手机被成功控制了，如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-17-00-50.png"/></p> <p>由于Airtest的编辑器中的代码运行后无法正常打印出中文，因此后面的代码都直接在PyCharm中执行。</p> <p>既然要做爬虫，就需要获取手机上的文字内容。回到搜索页面，我想知道“古剑奇谭”三这个关键字能搜索出多少条结果，每条结果有多少个讨论，如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-15-50-43.png"/></p> <p>此时我们需要做两件事情：</p> <p>E区的树状结构如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-15-54-25.png"/></p> <p>每一个搜索结果的标题作为text属性的值，在<code>name='com.zhihu.android:id/magi_title'</code>对应的元素中；每一个搜索结果的讨论数作为text属性的值，在<code>name='com.zhihu.android:id/magi_count'</code>对应的元素中。</p> <p>最直接的做法就是分别获取三个标题和三个讨论数，然后把它们合并在一起：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-17-05-27.png"/></p> <p>但是这种做法实际上是很危险的，假设会有某一个很生僻的搜索结果，只有标题没有讨论数，那么这样分开抓取再组合的做法，就会导致最后匹配错位。所以合理的做法是先抓大再抓小。每一组标题和讨论数，他们都有自己的父节点，如下图箭头所指向的三个<code>android.widget.LinearLayout</code>:</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-16-07-11.png"/></p> <p>那么现在，使用先抓大再抓小的技巧，先把每一组结果的父节点抓下来，再到每一个结果里面分别获取标题和讨论数。</p> <p>然而这个父节点又怎么获取呢？如下图所示，这个父节点每一个属性值都没有什么特殊的，写任何一个都有可能与别的节点撞上。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-17-15-07.png"/></p> <p>此时，最简单的办法，就是在E区，双击父节点。定位代码就会自动添加，如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-17-16-51.png"/></p> <p>这个定位代码看起来非常复杂，但实际上它的内在逻辑非常简单，就是从顶层一层一层往下找而已。</p> <p>自动生成的定位代码如下：</p> <p>在这个自动生成的定位代码中，我们看到了<code>offspring</code>、<code>child</code>这两种方法。其中<code>child</code>代表子节点，<code>offspring</code>代表孙节点、孙节点的子节点、孙节点的孙节点……。简言之，使用<code>child</code>只会在子节点中搜索需要的内容，而使用<code>offspring</code>会像文件夹递归一样把里面的所有节点都遍历一次，直到找到符合条件的属性为止。显然，offspring速度会比child慢。</p> <p>实际上，我们可以对这个定位代码做一些精简：</p> <p>这个精简的方法，与从Chrome复制的XPath中进行精简是一样的逻辑，根本原则就是找到“独一无二”的属性值，然后用这个属性值来进行定位。</p> <p>由于我点击的是第一个搜索结果，所以定位代码的最后有一个<code>[0]</code>。现在由于需要获得所有搜索结果的内容，所以应该去掉<code>[0]</code>而使用for循环展开，然后获取里面的内容：</p> <p>运行效果如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-17-30-30.png"/></p> <p>当我们在电脑上插入多个Android手机时，执行命令：</p> <p>运行效果如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-17-37-16.png"/></p> <p>每个手机都会被列出来。在最左边的编号就是手机串号。使用这个串号可以指定多个手机：</p> <p>通过这种方式，在一台电脑上使用USBHub，连上二三十台手机是完全没有问题的。</p> <p>Airtest支持无线模式，不需要USB，只要电脑和手机连接同一个WIFI就能控制：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/wireless_control.gif"/></p> <p>如果大家对如何开启无线模式有兴趣，请留言，我就会继续写。</p> <p>一台电脑可以连接三十台手机，那么如果有很多电脑和很多手机，就可以实现手机爬虫集群，其运行效果如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2019-01-19-17-44-57.png"/></p> <p>关于如何搭建爬虫集群，已经超出本文的范围了。如果大家有兴趣，可以阅读我的书：<a href="https://item.jd.com/12436581.html?dist=jd" rel="noopener" target="_blank">Python爬虫开发 从入门到实战</a>第十章对于如何搭建手机爬虫集群有详细的说明和注意事项。</p> <p>如果对我的书有兴趣，请关注我的微信公众号与我交流。</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    