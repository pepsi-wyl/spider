 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>2014年12月28号开始，Gmail被伟大的墙从协议上封禁，POP3、SMTP、IAMP全部阵亡。于是不仅网页不能打开Gmail，连邮件客服端都不能使用Gmail收发邮件了。</p> <p>Gmail在国内的用户相当的广泛，难道就真的不用了吗？当然不是。虽然使用VPN可以翻出长城，但是开着VPN做其他事情又不太方便。于是，一种Gmail的转发服务变得重要起来。</p> <p>这篇文章将详细介绍如何使用亚马逊云AWS的免费主机EC2，配合Gmail的API来编写一个Gmail的转发程序。程序在设定时间内访问Gmail收件箱，发现新邮件以后，就通过另一个邮箱转发到国内邮箱中。每一次转发记录到一个日志文件中，并使用Flask搭建网站来，从而直观的检查接收发送记录。</p> <p>AWS的免费主机EC2的申请不是本文的重点，网上有很多教程，故略去不讲。<br/>Flask环境的搭建不是本文重点，网上有很多教程，故略去不讲。</p> <p>本篇先讲解Gmail API的使用，下一篇讲解如何制作转发程序。</p> <p>既然要是用Gmail的API，那就要开通Gmail的授权。Google的官方英文教程请戳-&gt;<a href="https://developers.google.com/gmail/api/quickstart/quickstart-python" rel="noopener" target="_blank">Run a Gmail App in Python</a></p> <p>访问<a href="https://console.developers.google.com/project" rel="noopener" target="_blank">https://console.developers.google.com/project</a>，单击“建立档案”选项，新建一个项目。我这里新建的项目叫做“gmail”，如下图：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/1.jpg"/></p> <p>单击新建的档案“gmail”，在左侧点击“API和验证”，选择“API”，然后再右侧中间搜索框中输入Gmail，找到后打开。如下图：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/开启gmailapi.jpg"/></p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/openapi.jpg"/></p> <p>然后点击左侧“凭证”，选择“建立新的用户端ID”</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/凭证.jpg"/></p> <p>这个时候注意一定要选择第三项，才能正确生成json文件。选择第三项，并填写完一些信息后，做如下选择，并点击“建立用户端ID”</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/id.jpg"/></p> <p>接下来，下载json文件。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/oau.jpg"/></p> <p>在服务器上新建ghelper文件夹：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">mkdir ghelper</span><br/><span class="line">cd ghelper</span><br/></pre></td></tr></table></figure></p> <p>然后安装Google API Python Client库。建议使用pip安装而不是easy_install，因为pip安装的库文件可以卸载，而easy_install安装的库文件不能卸载。<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">sudo pip install --upgrade google-api-python-client</span><br/></pre></td></tr></table></figure></p> <p>为了使代码中的run.tools()能够正常执行，还需要安装gflags:<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">sudo pip install python-gflags</span><br/></pre></td></tr></table></figure></p> <p>将json文件上传到AWS服务器上，我放在了~/wwwproject/ghelper目录下面并且重命名为client_secret.json这样代码就不需要进行修改了。同时在本目录下面新建ghelper_api.py文件，文件内容为官方指南中的验证机器的代码，如下：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/></pre></td><td class="code"><pre><span class="line">import httplib2</span><br/><span class="line"></span><br/><span class="line">from apiclient.discovery import build</span><br/><span class="line">from oauth2client.client import flow_from_clientsecrets</span><br/><span class="line">from oauth2client.file import Storage</span><br/><span class="line">from oauth2client.tools import run</span><br/><span class="line"></span><br/><span class="line"># Path to the client_secret.json file downloaded from the Developer Console</span><br/><span class="line">CLIENT_SECRET_FILE = 'client_secret.json'</span><br/><span class="line"></span><br/><span class="line"># Check https://developers.google.com/gmail/api/auth/scopes for all available scopes</span><br/><span class="line">OAUTH_SCOPE = 'https://www.googleapis.com/auth/gmail.readonly'</span><br/><span class="line"></span><br/><span class="line"># Location of the credentials storage file</span><br/><span class="line">STORAGE = Storage('gmail.storage')</span><br/><span class="line"></span><br/><span class="line"># Start the OAuth flow to retrieve credentials</span><br/><span class="line">flow = flow_from_clientsecrets(CLIENT_SECRET_FILE scope=OAUTH_SCOPE)</span><br/><span class="line">http = httplib2.Http()</span><br/><span class="line"></span><br/><span class="line"># Try to retrieve credentials from storage or run the flow to generate them</span><br/><span class="line">credentials = STORAGE.get()</span><br/><span class="line">if credentials is None or credentials.invalid:</span><br/><span class="line">  credentials = run(flow STORAGE http=http)</span><br/><span class="line"></span><br/><span class="line"># Authorize the httplib2.Http object with our credentials</span><br/><span class="line">http = credentials.authorize(http)</span><br/><span class="line"></span><br/><span class="line"># Build the Gmail service from discovery</span><br/><span class="line">gmail_service = build('gmail' 'v1' http=http)</span><br/><span class="line"></span><br/><span class="line"># Retrieve a page of threads</span><br/><span class="line">threads = gmail_service.users().threads().list(userId='me').execute()</span><br/><span class="line"></span><br/><span class="line"># Print ID for each thread</span><br/><span class="line">if threads['threads']:</span><br/><span class="line">  for thread in threads['threads']:</span><br/><span class="line">    print 'Thread ID: %s' % (thread['id'])</span><br/></pre></td></tr></table></figure></p> <p>运行ghelper_api.py，进入Google验证阶段。<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">python ghelper_api.py</span><br/></pre></td></tr></table></figure></p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/sigin.jpg"/></p> <p>在红线处按回车键就可以进入输入模式。输入gmail和密码以后，移动光标到“Sign in”回车，然后进入如下页面：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/sign2.jpg"/></p> <p>输入你的信息，验证通过以后会让你进入开启浏览器的javascript功能。可是Linux服务器哪来的浏览器？这个时候按键盘的Ctrl + Z来取消。</p> <p>继续输入：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">python ghelper_api.py --noauth_local_webserver</span><br/></pre></td></tr></table></figure></p> <p>会提示离线验证，如果仍然失败的话，就继续Ctrl+Z然后再输入上面的代码，很快就会让你离线验证：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/sign3.jpg"/></p> <p>复制他给出的网址，并在自己电脑上登录后，复制他给出的代码并粘贴回服务器上。验证通过。</p> <p>打开<a href="https://developers.google.com/gmail/api/v1/reference/" rel="noopener" target="_blank">API Reference</a>，查看Gmail API的用法。</p> <p>这里用Users.messages的list和get方法来演示API的使用。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/listget.jpg"/></p> <p>先查看list的说明:</p> <p>Lists the messages in the user’s mailbox.</p> <p>列出邮箱里的信息。这里实际上列出来的是每一封邮件的id于是，使用这个id，通过get就能获得邮件的内容。</p> <p>通过查看list和get的使用范例：</p> <p>list:<br/><a href="https://developers.google.com/gmail/api/v1/reference/users/messages/list" rel="noopener" target="_blank">https://developers.google.com/gmail/api/v1/reference/users/messages/list</a><br/>get:<br/><a href="https://developers.google.com/gmail/api/v1/reference/users/messages/get" rel="noopener" target="_blank">https://developers.google.com/gmail/api/v1/reference/users/messages/get</a></p> <p>构造出以下的完整代码：</p> <p>通过观察GetMessage返回的数据，可以看到，返回的是一个字典dict邮件的内容在key为snippet的里面。发件人在[‘payload’][‘headers’][3][‘value’]里面，如图：<br/><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/data1.jpg"/><br/><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/data2.jpg"/></p> <p>代码在服务器上运行效果如图：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/gmail/show.jpg"/></p> <p>至此，Gmail API在AWS服务器上的部署完成。下一篇文章将会介绍如何使用Python轮询Gmail的收件箱，并在有新邮件的时候转发到国内邮箱。</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    