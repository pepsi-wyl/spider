 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>文章首发地址：<a href="http://kingname.info" rel="noopener" target="_blank">http://kingname.info</a></p> <p>这篇文章不会教你在技术角度上使用log，而是告诉你为什么要使用log日志功能。</p> <p>在<a href="http://kingname.info/2014/12/23/A-Totally-Amazing/" rel="noopener" target="_blank">使用微信控制你的电脑</a>这篇文章中，我写好了电脑端的程序，使用py2exe生成可执行文件，并把它们发送给我的朋友让他们进行测试。但是他们把_config.ini设置好以后，运行程序就看到一个黑色窗口一闪而过。或者有些人一开始看到程序能正常登陆邮箱，但是准备执行命令的时候，窗口自动关闭。</p> <p>由于没有日志记录程序的运行状态，我根据他们的描述很难定位到错误在哪个地方。于是折腾了一个下午。</p> <p>这个时候，我觉得添加一个日志的功能迫在眉睫。</p> <p>目前网上能找到的关于如何使用日志的文章，全部都是从技术角度讲怎么使用log：在XX地方应该先imort logging，然后basicconfig设定XX内容。可是我现在的问题是：</p> <p>于是我只有自己摸索。因此，<strong>以下内容是我自己摸索出来的野路子，可能会有错漏。希望有经验的朋友能给我指正，非常感谢。</strong></p> <p>使用<a href="http://kingname.info/2014/12/23/A-Totally-Amazing/" rel="noopener" target="_blank">使用微信控制你的电脑</a>文章中涉及到的例子</p> <p>程序入口代码如下：</p> <p>以上代码表示程序运行以后，首先执行init()函数，于是如果init()初始化没有什么问题，成功执行完成以后，就应该在日志中输出“初始化完成”，然后进入接收邮件的循环。如果程序窗口运行以后一闪而过，而且生成的日志中没有初始化完成这样的字眼，那就说明问题出在初始化上面。</p> <p>然而初始化函数里面代码也有很多，又如何知道是初始化程序里面的什么地方出问题了呢？</p> <p>所以，再初始化函数里面，也应该有一定的日志记录。</p> <p>再看初始化函数的代码：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/></pre></td><td class="code"><pre><span class="line">def init():</span><br/><span class="line">        global usernamepasswordhostboss_emailtime_limit</span><br/><span class="line">      	 </span><br/><span class="line">		try:</span><br/><span class="line">               f = open('_config.ini''r')</span><br/><span class="line">       	except IOErrore:</span><br/><span class="line">               logging.error(e)</span><br/><span class="line">			exit()</span><br/><span class="line"></span><br/><span class="line">        info = f.readlines()</span><br/><span class="line">		try:</span><br/><span class="line">	        host = re.search('host:(.*?)\n'info[0]re.S).group(1)</span><br/><span class="line">	        username = re.search('username:(.*?com)'info[1]re.S).group(1)</span><br/><span class="line">	        password = re.search('password:(.*?)\n'info[2]re.S).group(1)</span><br/><span class="line">	        boss_email = re.search('boss_email:(.*?com)'info[3]re.S).group(1)</span><br/><span class="line">	        time_limit = re.search('time_limit:(.*?)\n'info[4]re.S).group(1)</span><br/><span class="line">		except Exceptione:</span><br/><span class="line">               logging.error(e)</span><br/><span class="line"></span><br/><span class="line">        logging.info(u'打开配置文件成功。。。')</span><br/><span class="line">		</span><br/><span class="line"></span><br/><span class="line">        #将命令生成字典，便于查询</span><br/><span class="line">        command_start = info.index('&lt;command&gt;\n')</span><br/><span class="line">        command_end = info.index('&lt;/command&gt;\n')</span><br/><span class="line">        for each in info[command_start+1:command_end]:</span><br/><span class="line">                command = each.split('=')</span><br/><span class="line">                command_dict[command[0]] = command[1]</span><br/><span class="line">		</span><br/><span class="line">        logging.info(command_dict)</span><br/><span class="line">		</span><br/><span class="line">        open_start = info.index('&lt;open_file&gt;\n')</span><br/><span class="line">        open_end = info.index('&lt;/open_file&gt;\n')</span><br/><span class="line">        for each in info[open_start+1:open_end]:</span><br/><span class="line">                open_file = each.split('=')</span><br/><span class="line">                open_dict[open_file[0]] = open_file[1][:-1]</span><br/><span class="line">		</span><br/><span class="line">        logging.info(open_dict)</span><br/><span class="line">		</span><br/><span class="line">        f.close()</span><br/></pre></td></tr></table></figure></p> <p>在这段代码中，我使用try except命令捕获异常，如果发生异常，就使用logging.error将错误写入日志中。例如当_config.ini被改名了或者被删除的时候，程序就会报错，而通过日志就能发现这个错误。</p> <p>经过上面的代码，如果在初始化的过程中出错，就可以很快确定问题出在什么地方。</p> <p>初始化完成以后，进入邮件接收阶段。<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/></pre></td><td class="code"><pre><span class="line">def accp_mail():</span><br/><span class="line">        logging.info(u'开始检查邮箱')</span><br/><span class="line">		try:</span><br/><span class="line">	        pp = poplib.POP3_SSL(host)</span><br/><span class="line">	        pp.set_debuglevel(1)</span><br/><span class="line">	        pp.user(username)</span><br/><span class="line">	        pp.pass_(password)</span><br/><span class="line">	        ret = pp.list()</span><br/><span class="line">	        logging.info(u'登录邮箱成功。')</span><br/><span class="line">		except Exceptione:</span><br/><span class="line">			logging.error(e)</span><br/><span class="line">			exit()</span><br/><span class="line">		</span><br/><span class="line">		logging.info(u'开始抓取邮件。')</span><br/><span class="line">		try:</span><br/><span class="line">        	down = pp.retr(len(ret[1]))</span><br/><span class="line">			logging.info(u抓取邮件成功。'')</span><br/><span class="line">		except Exceptione:</span><br/><span class="line">			logging.error(e)</span><br/><span class="line">			exit()</span><br/><span class="line"></span><br/><span class="line">		logging.info(u'开始抓取subject和发件人')</span><br/><span class="line">        try:</span><br/><span class="line">               subject = re.search("Subject: (.*?)'"str(down[1]).decode('utf-8')re.S).group(1)</span><br/><span class="line">               sender = re.search("'X-Sender: (.*?)'"str(down[1]).decode('utf-8')re.S).group(1)</span><br/><span class="line">               logging.info(u'抓取subject和发件人成功')</span><br/><span class="line">       	except Exceptione:</span><br/><span class="line">               logging.error(e)</span><br/><span class="line">               exit()</span><br/><span class="line"></span><br/><span class="line">        if subject != 'pass':</span><br/><span class="line">                if sender == boss_email:</span><br/><span class="line">                        DealCommand(subject)</span><br/><span class="line">        pp.quit()</span><br/></pre></td></tr></table></figure></p> <p>以上这段代码，对邮箱的登录与邮件的读取均作了监控，一旦有某个环节出了问题，就会体现在日志中。</p> <p>通过在登录环节的try except返回的错误日志，发现有很多朋友无法登录邮箱，而密码用户名都没有错，从而推断是没有在新浪邮箱的账户控制里面打开客服端接收POP3和SMTP的功能。</p> <p>再来看DealCommand()函数：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/></pre></td><td class="code"><pre><span class="line">def DealCommand(subject):</span><br/><span class="line">        logging.info(u'开始处理命令。')</span><br/><span class="line">        send_mail('pass''slave')</span><br/><span class="line">        if subject in command_dict:</span><br/><span class="line">                logging.info(u'执行命令')</span><br/><span class="line">                try:</span><br/><span class="line">                        command = command_dict[subject]</span><br/><span class="line">                        os.system(command)</span><br/><span class="line">                        send_mail('Success''boss')</span><br/><span class="line">                        logging.info(u'执行命令成功')</span><br/><span class="line">                except Exceptione:</span><br/><span class="line">                        logging.error(e)</span><br/><span class="line">                        send_mail('error''boss'e)</span><br/><span class="line">        elif subject in open_dict:</span><br/><span class="line">                logging.info(u'打开文件')</span><br/><span class="line">                try:</span><br/><span class="line">                        open_file = open_dict[subject]</span><br/><span class="line">                        win32api.ShellExecute(0 'open' open_file ''''1)</span><br/><span class="line">                        send_mail('Success''boss')</span><br/><span class="line">                        logging.info(u'打开文件成功')</span><br/><span class="line">                except Exceptione:</span><br/><span class="line">                        logging.error(e)</span><br/><span class="line">                        send_mail('error''boss'e)</span><br/><span class="line">        else:</span><br/><span class="line">                send_mail('error''boss''no such command')</span><br/></pre></td></tr></table></figure></p> <p>执行命令的地方可能会出错，于是果断使用try except捕获错误。并使用日志记录。</p> <p>最后是send_mail()函数：<br/><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/></pre></td><td class="code"><pre><span class="line">def send_mail(subjectflagbody='Success'):</span><br/><span class="line">        </span><br/><span class="line">        msg = MIMEText(body'plain''utf-8')#中文需参数‘utf-8’，单字节字符不需要</span><br/><span class="line">        msg['Subject'] = subject</span><br/><span class="line">        msg['from'] = username</span><br/><span class="line">        logging.info('开始配置发件箱。')</span><br/><span class="line">        try:</span><br/><span class="line">                handle = smtplib.SMTP('smtp.sina.com' 25)</span><br/><span class="line">                handle.login(usernamepassword)</span><br/><span class="line">                logging.info('发件箱配置成功')</span><br/><span class="line">        except Exceptione:</span><br/><span class="line">                logging.error(e)</span><br/><span class="line">                exit()</span><br/><span class="line"></span><br/><span class="line">        logging.info(u'开始发送邮件'+ 'to' + flag)</span><br/><span class="line">        if flag == 'slave':</span><br/><span class="line">                try:</span><br/><span class="line">                        handle.sendmail(usernameusername msg.as_string())</span><br/><span class="line">                        logging.info(u'发送邮件成功')</span><br/><span class="line">                except Exceptione:</span><br/><span class="line">                        logging.error(e)</span><br/><span class="line">                        exit()</span><br/><span class="line">        elif flag == 'boss':</span><br/><span class="line">                try:</span><br/><span class="line">                        handle.sendmail(usernameboss_email msg.as_string())</span><br/><span class="line">                        logging.info(u'发送邮件成功')</span><br/><span class="line">                except Exceptione:</span><br/><span class="line">                        logging.error(e)</span><br/><span class="line">                        exit()</span><br/><span class="line">                </span><br/><span class="line">        handle.close()</span><br/><span class="line">        logging.info(u'发送邮件结束'+flag)</span><br/></pre></td></tr></table></figure></p> <p>这里对邮件发件的部分需要特别仔细的错误捕获，然后记录进入日志中。</p> <p>完整的代码见：<a href="https://github.com/kingname/MCC.git" rel="noopener" target="_blank">https://github.com/kingname/MCC.git</a>中的auto.py</p> <p>需要使用日志记录的地方大致有一下几处：</p> <p>这里我对一般信息的记录使用了info实际上，一般用作调试的话，是使用debug更多。</p> <p>需要用户输入的地方，总会有想不到的错误，多小心都不为过。例如，用户可能会把time_limit设定为一个全角数字。而本文中就没有捕获这种问题到日志中。所以如果不放心的话，还可以更进一步的细化日志。</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    