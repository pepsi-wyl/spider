 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>在以前的文章里面，我给大家介绍了使用Python自带的LRU缓存实现带有过期时间的缓存：<a href="https://mp.weixin.qq.com/s/idD-i8mGHx9zSBEXYI1QWg" rel="noopener" target="_blank">一日一技：实现有过期时间的LRU缓存</a>。也讲过倒排索引：<a href="https://mp.weixin.qq.com/s/AEDfZLlGcG5cgStCt_ZkeA" rel="noopener" target="_blank">使用倒排索引极速提高字符串搜索效率</a>。但这些代码对初学者来说比较难，写起来可能会出错。</p> <p>实际上，这些功能其实都可以使用Redis来实现，而且每个功能只需要1分钟就能做出来。全文搜索功能在搜索英文的时候，甚至可以智能识别拼写错误的问题。</p> <p>要实现这些功能，只需要做两件事：</p> <p>安装完成以后，我们来看看它有多简单：</p> <p>我们想实现一个装饰器，它装饰一个函数。让我在1分钟内多次访问函数的时候，使用缓存的数据；超过1分钟以后才重新执行函数的内部代码：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20211228185527.png"/></p> <p>我们再来看看全文搜索功能，实现起来也很简单：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20211228191027.png"/></p> <p>如果你想让他兼容拼写错误，那么可以把<code>search = db.Index('xxx')</code>改成<code>search = db.Index('xxx’ metaphone=True)</code>，运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20211228191314.png"/></p> <p>不过遗憾的是，这个全文搜索功能只支持英文。</p> <p>我们有时候要限制调用某个函数的频率，或者网站的某个接口要限制IP的访问频率。这个时候，使用<code>walrus</code>也可以轻松实现：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20211228192152.png"/></p> <p>其中参数<code>limit</code>表示能出现多少次，<code>per</code>表示在多长时间内。</p> <p><code>rate.limit</code>只要传入相同的参数，那么就会开始检查这个参数在设定的时间内出现的频率。</p> <p>你可能觉得这个例子并不能说明什么问题，那么我们跟FastAPI结合一下，用来限制IP访问接口的频率。编写如下代码：</p> <p>上面代码定义了一个全局的异常拦截器：</p> <p>在整个代码的任何地方抛出了<code>RateLimitException</code>异常，就会进入这里的逻辑中。</p> <p>使用装饰器<a href="/cdn-cgi/l/email-protection#cdad8dbfacb9a8e3bfacb9" rel="noopener" target="_blank">`@rate.rat</a>e_limited<code>装饰一个路由函数，并且这个装饰器要更靠近函数。路由函数接收什么参数，它就接收什么参数。在上面的例子中，我们只接收了</code>request<code>参数，用于获取访问者的IP。发现这个IP的访问频率超过了限制，就抛出一个</code>RateLimitException<code>。于是前面定义好的全局拦截器就会拦截</code>RateLimitException`异常，拦截到以后返回我们定义好的报错信息。</p> <p>在频率范围内访问页面，返回正常的JSON数据：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20211228205416.png"/></p> <p>频率超过设定的值以后，访问页面就会报错，如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20211228205337.png"/></p> <p><code>walrus</code>对<code>redis-py</code>进行了很好的二次封装，用起来非常顺手。除了上面我提到的三个功能外，它还可以实现几行代码生成布隆过滤器，实现自动补全功能，实现简易图数据库等等。大家可以访问它的<a href="https://walrus.readthedocs.io/en/latest/getting-started.html" rel="noopener" target="_blank">官方文档了解详细使用说明</a>。</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    