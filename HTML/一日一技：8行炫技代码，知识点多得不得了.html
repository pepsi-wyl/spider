 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>我们今天来看一段炫技代码。它可以把任何能接收两个参数的函数定义成一个特殊的运算符。</p> <p>例如，我们知道Python里面的<code>range</code>函数，最少可以接收1个参数，最多能够接收3个参数。当只有两个参数的时候，格式为<code>range(开始 结束)</code>，从开始数字到结束数字逐次加1，左闭右开。使用今天的方法，可以把它的写法改为<code>开始 |到| 结束</code>，如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220127191711.png"/></p> <p>又比如，<code>urllib.parse.urljoin</code>可以把域名和一个相对路径拼接起来: <code>urljoin(域名 相对路径)</code>，我们也可以改写成如下图所示的格式：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220127192252.png"/></p> <p>这种炫技有余，实用不足的功能是怎么实现的呢？其实原理非常简单，只有8行代码：</p> <p>这里就涉及到一个盲点和两个真正的知识点。这个盲点就是，你可能以为<br/><code>|到|</code>是一个字符，但是它是3个字符；你可能会把<code>|拼接|</code>看做一个整体，但是它实际上是3个部分：左边的<code>|</code>、<code>拼接</code>和右边的<code>|</code>。</p> <p>我们把空格加上，就很明显了：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220127194754.png"/></p> <p>两个真正的知识点，就是<code>__or__</code>和<code>__ror__</code>这两个魔术方法和偏函数<code>partial</code>。而<code>Change</code>本身就是一个普通的类而已，<code>__or__</code>和<code>__ror__</code>定义了这个类的实例在左侧遇到<code>|</code>时，右侧遇到<code>|</code>时的具体行为。</p> <p>我们一个一个来讲。首先是<code>__or__</code>。它定义了实例的右侧遇到<code>|</code>时的具体行为。例如，我们用一个简单的代码来进行测试：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220127193556.png"/></p> <p>但如果你把竖线放在左边，他就会报错，如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220127193742.png"/></p> <p>而<code>__ror__</code>就是用来定义<code>|</code>在实例左边的时候，它的行为：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220127193858.png"/></p> <p>所以，我们最开始的例子中，<code>2 |到| 10</code>，实际上应该理解为：</p> <p>在我们演示的例子中，<code>2 | 到</code>首先进入了<code>Change</code>类的<code>__ror__</code>方法中：</p> <p>其中，一开始的<code>self.func</code>就是我们在初始化实例<code>Change(range)</code>时传入的参数<code>range</code>。所以<code>partial(self.func other)</code>等价于<code>partial(range 2)</code>。关于偏函数<code>partial</code>，大家可以看我这篇文章：<a href="https://mp.weixin.qq.com/s/veP19kUQgnyiivDoJH8_9g" rel="noopener" target="_blank">偏函数：在Python中设定默认参数的另一种办法</a>。简单来说，使用偏函数，可以给一个真正的函数传一部分参数，过一会再补剩下的参数。</p> <p>可能大家在日常的开发者，很少会让一个实例方法返回<code>self</code>。关于这个写法，大家可以看我的这一篇文章：<a href="https://mp.weixin.qq.com/s/Y689WhpOopHdI8hbCGcFMg" rel="noopener" target="_blank">一日一技：在Python里面实现链式调用</a>。也就是说，<code>1 | 到</code>返回的，依然是<code>Change</code>类的一个实例，我们简称它为<code>x</code>。这个实例的属性<code>self.func</code>的值是<code>partial(range 2)</code>。</p> <p>接下来，<code>x | 10</code>，调用的是<code>__or__</code>方法，于是，此时执行的是<code>partial(range 2)(10)</code>。偏函数的参数补全了，于是它里面的<code>range</code>真正运行了起来，成为了<code>range(2 10)</code>。</p> <p>至此，这个<code>Change</code>类我们就解析透了。大家知道，在Python里面，魔术方法是有很多的，如果你不想用<code>|</code>，你还可以用其它的，例如：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220127195758.png"/></p> <p>或者：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220127195832.png"/></p> <p>或者：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220127195904.png"/></p> <p>同时，这个<code>Change</code>类，你甚至可以直接当做装饰器来使用。任何能够接收两个参数的函数，都能使用这个装饰器。例如：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220127200446.png"/></p> <p>最后总结一下。大家都知道，我是非常反对在工作代码中炫技的，因为炫技的写法很难读，很难维护。今天这个炫技的方法，虽然我也不推荐大家用在工作中，但是它短短8行代码里面，包含了很多个知识点，这就值得大家玩一玩了。</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    