 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>假设有这样一个场景，你接了一个私活，帮别人做一个软件，软件没有联网功能。东西做好以后，客户还没有给钱，说要先试用一下。你选择了相信客户，把软件发送给了他。然后他就把你拉黑了。</p> <p>为了避免这种情况发生，你首先想到的办法，肯定是把过期时间写死到代码里面，时间到了App自动销毁。对方付钱以后，你再把这个写死的时间延长或者去掉。再重新编译后发给客户。</p> <p>但问题是，每次重新编译代码并发给用户是非常麻烦的事情，有没有更简单的办法呢？能不能软件始终是一个软件，但是给用户一个注册码，这个注册码里面标记了有效时间。等到过期以后，只需要给用户一个新的注册码，就可以继续使用了。</p> <p>看到这里，有同学肯定会想，怎么在注册码指定有效期呢？首先这个时间肯定不能是明文的，否则用户把它一改，岂不是就可以自行延长了。</p> <p>但如果加密的话，就必须把解密算法放到软件里面，一旦用户对程序进行初步的反编译，就能拿到解密算法或者对称加密的密钥。</p> <p>因此，我们只能使用非对称加密。而非对称加密里面，通过公钥加密，使用私钥解密。如果我们要让软件从注册码里面解码出有效时间，难道要在软件里面放私钥？</p> <p>私钥不能泄露，因此放到软件里面的只能是公钥。但是难道能使用私钥加密，用公钥解密？</p> <p>实际上，真的可以这样做，但这不叫做私钥加密公钥解密，这叫做私钥签名(sign)，公钥验证(verify)。并且，使用这个方法有一个好处，就是有效时间可以直接明文存放，不怕用户修改。因为一旦修改了，签名就匹配不上。</p> <p>假设我们有一个字符串<code>message</code>，使用私钥，可以对这个字符串进行签名，获得一个签名字符串<code>signature</code>。而我们用公钥，可以验证<code>message</code>是否能够生成签名字符串<code>signature</code>。如果<code>message</code>发生了修改，或者<code>signature</code>发生了修改，或者<code>message</code>和<code>signature</code>同时发生了修改，公钥验证都会失败。</p> <p>各个语言都有非对称加密相关的第三方库。我们用Python中的<code>PyCryptodome</code>来进行演示。</p> <p>首先，我们在macOS下面，生成一对公钥和私钥：</p> <p>根据提示输入密钥的储存路径就可以了，如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220222182848.png"/></p> <p>在当前文件夹，生成了私钥<code>sign</code>和公钥<code>sign.pub</code>。</p> <p>接下来，使用<code>pip</code>安装<code>PyCryptodome</code>:</p> <p>接下来，导入公钥和私钥：</p> <p>由于我们之前生成密钥使用的是<code>SHA256</code>算法，因此我们需要用<code>SHA256</code>算法对需要签名的数据生成摘要。这一步在签名和验证签名的时候都需要做。</p> <p>接下来，对这个数据进行签名：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220222183837.png"/></p> <p>现在，你只需要把字符串<code>expire: 2022-03-01</code>和签名字符串<code>xbelbTNpq8M...很长一串...</code>发送给客户就可以了。</p> <p>客户把过期时间的字符串和签名字符串输入到软件以后，软件使用公钥来验证这个字符串是不是由自己对应的私钥签名的：</p> <p>但如果你篡改了<code>message</code>的内容，那么验证就会失败，如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220222192954.png"/></p> <p>软件第一次验证通过以后，就可以把这个过期时间的字符串和签名字符串一起用文件的形式存到硬盘上，每次启动软件的时候都检查一遍。发现合法并且没有过期就正常运行。发现过期了或者不合法就就重新弹出输入注册码的对话框。</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    