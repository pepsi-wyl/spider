 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>我们有时候需要把一些机密文件发给多个客户，为了避免客户泄露文件，会在机密文件中添加水印。每个客户收到的文件内容相同，但是水印都不相同。这样一来，如果资料泄露了，通过水印就知道是从谁手上泄露的。</p> <p>今天，一个做市场的朋友找我咨询一个加水印的问题，如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220503222817.png"/></p> <p>他有一个Excel文件，文件里面有10000个经销商的名字，他要把价目表PDF发给这些经销商，每个经销商收到的PDF文件上面的水印都是这个经销商自己的名字。</p> <p>这个需求手动操作肯定要累死人。但是如果用Python来做，就非常简单。代码不超过30行。</p> <p>要完成这个需求，需要安装两个模块，分别叫做<code>reportlab</code>和<code>pikepdf</code>。使用Pip安装就可以了：</p> <p>然后，需要找到一个<code>.ttf</code>或者<code>.ttc</code>格式的中文字体。你可以直接从网上下载中文字体文件。也可以使用系统自带的中文字体。这里以寻找macOS系统默认的宋体为例。</p> <p>macOS系统字体在<code>/System/Library/Fonts</code>，宋体对应的<code>.ttc</code>文件地址是<code>/System/Library/Fonts/Supplemental/Songti.ttc</code>。对于系统默认的字体，我们只需要知道它的对应的文件名叫做<code>Songti.ttc</code>就可以了。如果是从网上下载的第三方字体，需要使用绝对路径或者相对于项目代码的相对路径。</p> <p>由于这位朋友不会使用pandas，那么我们就尽量使用Python原生的方法来获得经销商名字列表。假设经销商信息对应的Excel如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220503224007.png"/></p> <p>我们首先把这个Excel文件导出成csv文件：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220503224408.png"/></p> <p>然后，我们用Python读取这个csv文件，获得经销商名字列表：</p> <p>运行效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220503224437.png"/></p> <p>一般来说，我们不能直接把一段文字作为水印添加到另一个PDF文件中。我们只有先把这段文字生成图片或者生成水印PDF文件，然后把这个图片或者水印PDF作为『图层』覆盖到目标PDF上面。</p> <p>因此，现在需要把给每一个经销商生成对应的水印PDF文件。这个PDF中只含有水印文字。效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220503225754.png"/></p> <p>对应的代码<code>create_watermark.py</code>如下：</p> <p>代码的具体作用，已经写到注释中了。运行以后会在当前项目根目录生成<code>water_pdf</code>文件夹，里面就是生成的水印PDF。</p> <p>最后一步，把每一个经销商的水印PDF与目标PDF进行合并。水印PDF作为一个图层覆盖到目标PDF上面。</p> <p>使用<code>pikepdf</code>完成这个工作非常简单，编写一个<code>combine.py</code>文件，代码如下：</p> <p>运行以后，会在项目根目录生成一个<code>result</code>文件夹，里面就是添加了水印的PDF文件了，如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220503231815.png"/></p> <p>这里有必要对代码中的一些地方进行解释。带上行号的代码如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220503232736.png"/></p> <p>代码第21行和22行，有两个<code>for</code>循环，他们的作用是给一个页面上添加多个水印。请大家注意下图我画圈的地方：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20220503232313.png"/></p> <p>每一页都有6个水印，分成3行2列。其中的3行对应了变量<code>row</code>的值。2列对应了变量col的值。大家也可以根据自己的需要修改这两个数字。甚至每一页的水印随机变换位置，防止被去水印的程序移除。</p> <p><code>page.trimbox[2]</code>是PDF页面的宽度，<code>page.trimbox[3]</code>是PDF页面的高度。</p> <p>大家注意在这篇文章中，我把任务分成了3个部分，分别是：</p> <p>这三个部分的代码是可以合并在一个<code>.py</code>文件里面的，但是我没有这样做，是考虑到问这个问题的同学不是程序员，Python水平只是入门，如果合并在一起，代码量多了以后，出问题都不知道错在哪里。</p> <p>在计算机领域，所有问题都可以通过把问题拆分成多个部分分别单独运行或者增加若干个中间层来解决。今天用的方法就是把问题拆分的方法。对于初学者来说，每一步都是相对独立的，都能立刻看到效果。第二步只需要依赖第一步的结果，第三步只需要依赖第二步的结果，这样每一步的输入输出非常清楚，可以显著降低问题的复杂度。如果报错了，也更容易知道是哪个地方有问题。</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    