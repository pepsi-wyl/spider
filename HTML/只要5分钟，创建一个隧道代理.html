 
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
    <p class="site-subtitle">给时光以生命。</p> <p>什么是隧道代理？我们来看下面这张截图：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-07-23-08-41-21.png"/></p> <p>所谓隧道代理，就是一个能帮你自动更换代理 IP 的代理服务。在你的代码里面，你只需要把一个入口代理地址写死，然后正常发起请求，而目标服务器接收到的请求，每一次都是不同的代理地址。</p> <p>在某代理网站上，隧道代理50并发每秒的价格是4000元/月：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-07-23-08-47-07.png"/></p> <p>而常规的，先请求接口拿到一批代理 IP，再选一个发起请求的原始代理服务器，一个月价格才600多元：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-07-23-08-49-41.png"/></p> <p>所以，如果我们能自己做一个隧道代理，将会省下很多钱！</p> <p>隧道代理的原理，跟常规代理的不同之处，用下面这两张图就能说清楚：</p> <p><img alt="传统代理服务" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-07-23-21-08-36.png"/></p> <p><img alt="隧道代理" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-07-23-21-11-06.png"/></p> <p>要自己开发一个这样的隧道代理，我们需要做两步：</p> <p>假设你从代理供应商手上买到的便宜代理地址为：<code>http://xxx.com/ips</code>，直接在浏览器上面请求，页面效果如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/20210723163643.png"/></p> <p>现在，你需要做的就是写一个程序，周期性访问这个url，拉取当前最新可用的IP地址，然后把它放到Redis中。</p> <p>这里，我们使用Redis的Hash这个数据结构，其中Hash的字段名就是<code>IP:端口</code>，里面的值就是跟每个IP相关的一些信息。</p> <p>你这个程序需要确保，当前在Redis里面的代理地址，全部都是可用的。这里，我给出了一个示例程序：</p> <p>其中，我把Redis相关的配置、代理供应商的URL写到了一个yaml配置文件中，防止被你们看到。配置文件的格式如下图所示：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-07-23-21-13-08.png"/></p> <p>由于我这个代理供应商提供的IP，有效期是1-5分钟，所以保险起见，我每40秒更换一次IP。更换的时候，采用了增量更换的方式。把当前拉取的IP和Redis里面的已有IP进行对比。不在这次拉取的IP全部从Redis移除，然后把新增的IP加到Redis中。</p> <p>大家在实际过程中，还可以加一些代理校验的逻辑，确保从URL拉下来的代理也进行有效性检查，发现无效的立刻移除。</p> <p>要实现自动转发，我们可以使用<a href="https://openresty.org/cn/" rel="noopener" target="_blank">OpenResty</a>。这是一个基于Nginx和Lua实现的高性能Web平台。通过它，我们可以使用Lua语言实现一些逻辑，例如从Redis读取数据，把来源请求转发到上游代理服务器……</p> <p>因此，我们使用OpenResty搭建一个转发服务。并把这个转发服务所在服务器的IP地址作为我们的入口IP地址。在使用Requests等等网络请求客户端发送请求的时候，只需要把这个入口IP地址设置为代理。那么，当客户端发送请求的时候，请求首先到了OpenResty。然后它从Redis中随机选一个代理IP来作为上游代理，并把刚刚发来的请求转发到上游代理。从而实现隧道代理的效果。</p> <p>Lua是一门非常老的语言，它的语法不少地方跟Python不太一样。不过你不用担心，这个配置文件我已经写好了。大家拿过来改一改就能用。</p> <p>对应的配置文件如下图所示：</p> <p>需要修改的地方，我在配置文件里面已经做好的注释。具体而言，需要修改地方包含：</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-07-23-21-18-54.png"/></p> <p>设置好了这些配置以后，我们就可以使用Docker来启动它。Docker的配置文件极其简单：</p> <p>然后，执行命令构建和运行：</p> <p>运行以后，你会看到Docker的命令行似乎卡住了。这是正常请求。因为需要你有了请求，它才会输出内容。</p> <p>现在，你可以用Requests赶快写一段代码来进行验证：</p> <p>运行效果如下图所示。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/2021-07-23-08-41-21.png"/></p> <p>说明隧道代理搭建成功。目前隧道代理我已经稳定运行了半年，从来没有出过问题，大家可以放心使用。</p> <p>最后，本文受到 @萌木盖 的文章：<a href="https://www.jianshu.com/p/7808ee6395ab" rel="noopener" target="_blank">openresty正向代理搭建 - 简书</a>的启发，并在该文章基础上进行改进。特别感谢原作者。</p> <p>如果本文讲到的方法，能帮你节省下不少购买隧道代理的钱，那么请考虑拿出其中的一小部分，加入我的知识星球，成为<code>未闻Code·Pro会员</code>。</p> <p><img alt="" src="https://kingname-1257411235.cos.ap-chengdu.myqcloud.com/51122141524284T2.JPG"/></p> <p>加入星球，你除了能获得在微信群中已有的全部福利外，还会额外获得：</p> <p class="site-author-name" itemprop="name">谢乾坤 | Kingname</p> <p class="site-description motion-element" itemprop="description">高级数据挖掘工程师，《Python 爬虫开发 从入门到实战》、《左手 MongoDB 右手 Redis——从入门到商业实战》作者。 微软最有价值专家 MVP，Python Scrapy MongoDB Redis Pandas Golang。</p>
    </body>
    </html>
    